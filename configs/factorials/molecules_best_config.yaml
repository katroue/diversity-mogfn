# ============================================================================
# BEST CONFIGURATION FROM COMPREHENSIVE FACTORIAL ANALYSIS (MOLECULES)
# ============================================================================
# Purpose: Validate the optimal hyperparameter configuration identified through
#          comprehensive cross-factorial analysis (135 experiments)
#
# UPDATED 2025-12-11: Configuration corrected based on comprehensive analysis
#
# Best Configuration Found (QDS-optimized, verified across 3 factorial studies):
#   - Model: 64 hidden dimensions, 2 layers MLP (SMALL capacity)
#   - Sampling: Temperature = 1.0 (LOW exploration - critical for chemistry!)
#   - Loss: Trajectory Balance (TB) - simpler, better quality
#   - Conditioning: Concat mechanism
#
# Selection Criterion: Highest QDS across ALL factorial conditions
#   - QDS: 0.656 (rank 1-5/135 - BEST overall across all factorials!)
#   - MCE: 0.290 (moderate - focused chemical diversity)
#   - Hypervolume: ~0.09 (improved quality)
#   - TDS: 0.90+ (very high - molecular trajectories are diverse)
#
# Key Insight: LOW temperature (τ=1.0) is CRITICAL for chemical validity!
# Previous config had wrong hidden_dim (32 vs 64) and wrong loss
#
# Rationale: Small models with low temperature maintain chemical validity
#            while exploring diverse molecular structures
#
# Experimental Design: 1 condition × 5 seeds = 5 runs
# ============================================================================

experiment_name: "molecules_best_config"
study_type: "validation"

# ============================================================================
# FIXED PARAMETERS (Best configuration from comprehensive factorial analysis)
# ============================================================================

fixed:
  # Task: Molecules generation
  environment: 'molecules'
  max_fragments: 8
  num_fragments_library: 15
  use_rdkit: True
  objective_properties:
    - "qed"
    - "sa"
    - "logp"

  # Model architecture (SMALL capacity 64×2 - optimal for molecules)
  hidden_dim: 64        # Changed from 32 - better capacity for QDS
  num_layers: 2
  conditioning: "concat"
  activation: "relu"

  # Loss function (using modifications: none format from factorial)
  modifications: "none"
  modifications_params: {}

  # Preference sampling (CRITICAL: Low temperature)
  preference_distribution: "dirichlet"
  temperature: 1.0      # LOW exploration - CRITICAL for chemical validity
  dirichlet_alpha: 1.5
  num_preferences_per_batch: 16
  sampling_strategy: "categorical"

  # Training
  max_iterations: 10000
  batch_size: 128
  optimizer: "adam"
  learning_rate: 0.001
  gradient_clip: 10.0

  # Evaluation
  eval_every: 500
  eval_samples: 1000
  final_eval_samples: 10000

  # Seeds
  num_seeds: 5
  base_seed: 42

# ============================================================================
# FACTORIAL DESIGN (Single condition: best loss configuration)
# ============================================================================

factors:
  # Factor: Loss Function (trajectory balance performs best)
  loss:
    description: "GFlowNet training objective"
    levels:
      tb:
        label: "Trajectory Balance"
        loss_function: "trajectory_balance"
        loss_params:
          log_reward_clip: 10.0
        regularization: "none"
        regularization_params: {}

# ============================================================================
# EXPERIMENTAL CONDITIONS (Single condition)
# ============================================================================

conditions:
  - name: "small_low_tb"
    loss: "tb"

# ============================================================================
# METRICS TO EVALUATE
# ============================================================================

metrics:
  primary:
    - quality_diversity_score  # QDS: PRIMARY selection criterion
    - trajectory_diversity_score  # TDS: Path diversity (very important for molecules)
    - mode_coverage_entropy  # MCE: Spatial diversity
    - hypervolume  # Quality: Pareto front coverage

  secondary:
    - preference_aligned_spread  # PAS: Diversity aligned with preferences
    - pareto_front_smoothness  # PFS: Preference alignment
    - flow_concentration_index  # FCI: Flow concentration
    - diversity_efficiency_ratio  # DER: Diversity per computation
    - pairwise_minimum_distance  # PMD: Objective space spread
    - replay_buffer_diversity  # RBD: Training sample diversity

# ============================================================================
# VALIDATION OBJECTIVES
# ============================================================================

validation:
  purpose: "Confirm optimal QDS-based configuration performance on Molecules"

  hypotheses:
    h1_qds:
      statement: "Best config achieves very high Quality-Diversity Score (QDS)"
      prediction: "QDS > 0.650"
      rationale: "Small model (64×2) with low temp (τ=1.0) balances quality and diversity"

    h2_tds:
      statement: "Best config achieves very high Trajectory Diversity Score"
      prediction: "TDS > 0.85"
      rationale: "Molecular construction paths are inherently diverse"

    h3_mce:
      statement: "Best config achieves moderate Mode Coverage Entropy"
      prediction: "MCE > 0.25"
      rationale: "TB loss with small model enables diverse mode coverage"

    h4_validity:
      statement: "Best config generates chemically valid molecules"
      prediction: "Validity > 90%"
      rationale: "Low temperature (τ=1.0) ensures precise fragment selection"

  expected_performance:
    qds_mean: ">0.650"
    qds_std: "<0.010"
    tds_mean: ">0.85"
    tds_std: "<0.030"
    mce_mean: ">0.25"
    mce_std: "<0.030"
    hypervolume_mean: ">0.020"
    hypervolume_std: "<0.005"

  comparison_baseline:
    description: "Compare against factorial best QDS performers"
    expectation: "Best config should match factorial best QDS (~0.656)"

# ============================================================================
# COMPUTATIONAL RESOURCES
# ============================================================================

resources:
  total_runs: 5  # 1 condition × 5 seeds
  estimated_time_per_run: "45 minutes"
  total_time_sequential: "3.75 hours"
  total_time_parallel: "45 minutes"  # With 5 parallel jobs

  storage_per_run: "~40 MB"
  total_storage: "~200 MB"

# ============================================================================
# SUCCESS CRITERIA
# ============================================================================

success_criteria:

  minimum_performance:
    qds: 0.65  # Must exceed 0.65 for top-tier quality-diversity
    tds: 0.80  # Must exceed 0.80 for trajectory diversity
    mce: 0.25  # Must exceed 0.25 for mode coverage
    validity: 0.85  # Must exceed 85% valid molecules

  statistical_significance:
    description: "Performance must match or exceed factorial best on QDS"
    alpha: 0.05
    required_p_value: "<0.05"

  stability:
    description: "Low variance across seeds indicates stable configuration"
    max_coefficient_of_variation: 0.15  # CV = std/mean < 0.15

# ============================================================================
# CHANGELOG
# ============================================================================
# 2025-12-11: Updated based on comprehensive 135-experiment analysis
#   - Changed hidden_dim: 32 → 64 (better capacity for QDS)
#   - Changed loss: SubTB+entropy → TB (better quality metrics)
#   - Updated expected QDS: 0.63 → 0.65 (improvement)
#   - Updated expected MCE: 0.18 → 0.25 (significant improvement)
#   - Updated condition name: small_subtb_entropy → small_low_tb
#   - Kept temperature at 1.0 (was already correct - LOW is critical!)
#   - Backup saved as: molecules_best_config_old.yaml
