# ============================================================================
# BEST CONFIGURATION FROM COMPREHENSIVE FACTORIAL ANALYSIS (DNA SEQUENCES)
# ============================================================================
# Purpose: Validate the optimal hyperparameter configuration identified through
#          comprehensive cross-factorial analysis (135 experiments)
#
# UPDATED 2025-12-12: Configuration corrected based on average-based selection
#
# Best Configuration Found (verified across 3 factorial studies):
#   - Model: 64 hidden dimensions, 3 layers MLP (MEDIUM capacity)
#   - Sampling: Very high temperature (τ=5.0) for broad exploration
#   - Loss: Trajectory Balance (TB) - simpler, better quality
#   - Conditioning: Concat mechanism
#
# Selection Criterion: Highest average QDS across factorial studies
#   - QDS: 0.6009 ± 0.0010 (excellent + stable!)
#   - MCE: 0.4631 (good mode coverage)
#   - Hypervolume: 0.3644 (balanced quality)
#   - Stability: CV = 0.17% (very low variance)
#
# Key Insight: MEDIUM models (64×3) with high temperature achieve best QDS!
# Previous config (small_tb 64×2) ranked only #8-10 (QDS: 0.5378 vs 0.6009)
#
# Rationale: Medium capacity with high temperature exploration balances
#            quality and diversity for RNA design tasks
#
# Experimental Design: 1 condition × 5 seeds = 5 runs
# ============================================================================

experiment_name: "sequences_best_config"
study_type: "validation"

# ============================================================================
# FIXED PARAMETERS (Best configuration from comprehensive factorial analysis)
# ============================================================================

fixed:
  # Task: DNA sequences generation
  environment: 'sequences'
  seq_length: 20
  temperature_seq: 37.0  # Celsius for ViennaRNA stability calculations
  use_viennarna: True
  objective_properties:
    - "free_energy"
    - "num_base_pairs"
    - "inverse_length"

  # Model architecture (MEDIUM capacity - optimal for QDS!)
  hidden_dim: 64        # 64 hidden dimensions
  num_layers: 3         # 3 layers (medium capacity)
  conditioning: "concat"
  activation: "relu"

  # Loss function (using modifications: none format from factorial)
  modifications: "none"
  modifications_params: {}

  # Preference sampling (CRITICAL: Very high temperature)
  preference_distribution: "dirichlet"
  temperature: 5.0      # Very high temperature - critical for exploration
  dirichlet_alpha: 1.5
  num_preferences_per_batch: 16
  sampling_strategy: "categorical"

  # Training
  max_iterations: 20000
  batch_size: 128
  optimizer: "adam"
  learning_rate: 0.001
  gradient_clip: 10.0

  # Evaluation
  eval_every: 1000      # Changed from 500 - sequences are slower
  eval_samples: 1000
  final_eval_samples: 10000

  # Seeds
  num_seeds: 5
  base_seed: 42

# ============================================================================
# FACTORIAL DESIGN (Single condition: best loss configuration)
# ============================================================================

factors:
  # Factor: Loss Function (trajectory balance performs best)
  loss:
    description: "GFlowNet training objective"
    levels:
      tb:
        label: "Trajectory Balance"
        loss_function: "trajectory_balance"
        loss_params:
          log_reward_clip: 10.0
        regularization: "none"
        regularization_params: {}

# ============================================================================
# EXPERIMENTAL CONDITIONS (Single condition)
# ============================================================================

conditions:
  - name: "medium_veryhigh_tb"
    loss: "tb"

# ============================================================================
# METRICS TO EVALUATE
# ============================================================================

metrics:
  primary:
    - hypervolume  # Quality: MAJOR improvement expected
    - mode_coverage_entropy  # MCE: Spatial diversity
    - quality_diversity_score  # QDS: Combined metric
    - pareto_front_smoothness  # PFS: Preference alignment

  secondary:
    - trajectory_diversity_score  # TDS: Path diversity
    - preference_aligned_spread  # PAS: Diversity aligned with preferences
    - flow_concentration_index  # FCI: Flow concentration
    - diversity_efficiency_ratio  # DER: Diversity per computation
    - pairwise_minimum_distance  # PMD: Objective space spread
    - replay_buffer_diversity  # RBD: Training sample diversity

# ============================================================================
# VALIDATION OBJECTIVES
# ============================================================================

validation:
  purpose: "Validate optimal config from average-based factorial selection"

  hypotheses:
    h1_qds:
      statement: "Optimal config achieves QDS > 0.590"
      prediction: "QDS ~0.601 (factorial best: 0.6009)"
      rationale: "Medium model (64×3) with high temp achieves best QDS across factorials"

    h2_mce:
      statement: "Optimal config achieves MCE > 0.450"
      prediction: "MCE ~0.463"
      rationale: "High temperature promotes diverse mode exploration"

    h3_hypervolume:
      statement: "Optimal config achieves HV > 0.350"
      prediction: "HV ~0.364"
      rationale: "Medium capacity balances quality and diversity"

    h4_stability:
      statement: "Config provides excellent stability across seeds"
      prediction: "CV < 0.02 for QDS"
      rationale: "Factorial showed CV = 0.17% - extremely stable"

  expected_performance:
    qds_mean: ">0.590"
    qds_std: "<0.005"
    hypervolume_mean: ">0.350"
    hypervolume_std: "<0.020"
    mce_mean: ">0.450"
    mce_std: "<0.020"
    pfs_mean: "<0.300"
    pfs_std: "<0.050"

  comparison_baseline:
    description: "Compare against previous selection (small_tb: QDS=0.538)"
    expectation: "Improved config should achieve +11.7% QDS improvement"

# ============================================================================
# COMPUTATIONAL RESOURCES
# ============================================================================

resources:
  total_runs: 5  # 1 condition × 5 seeds
  estimated_time_per_run: "30 minutes"
  total_time_sequential: "2.5 hours"
  total_time_parallel: "30 minutes"  # With 5 parallel jobs

  storage_per_run: "~30 MB"
  total_storage: "~150 MB"

# ============================================================================
# SUCCESS CRITERIA
# ============================================================================

success_criteria:

  minimum_performance:
    qds: 0.59  # Must exceed 0.59 (vs previous 0.538)
    mce: 0.45  # Must exceed 0.45 (vs previous 0.255)
    hypervolume: 0.35  # Must exceed 0.35 (realistic target)
    pfs: 0.30  # Lower is better

  statistical_significance:
    description: "Performance must exceed previous selection (small_tb) on QDS and MCE"
    alpha: 0.05
    required_p_value: "<0.05"

  stability:
    description: "Low variance across seeds indicates stable configuration"
    max_coefficient_of_variation: 0.05  # CV = std/mean < 0.05 (very stable)

# ============================================================================
# ALTERNATIVE CONFIGURATION NOTE
# ============================================================================
# Alternative options from factorial analysis:
#
# Option 2: large_veryhigh_tb (2nd best by QDS)
#   - hidden_dim: 128, num_layers: 4
#   - temperature: 5.0
#   - loss: trajectory_balance
#   - Expected QDS: 0.5995, MCE: 0.4831, HV: 0.2845
#   - Trade-off: -0.2% QDS, +4.3% MCE, -22% HV vs medium_veryhigh
#
# Option 3: veryhigh_tb (from sampling_loss factorial)
#   - hidden_dim: varies by sampling temp
#   - temperature: 5.0
#   - loss: trajectory_balance
#   - Expected QDS: 0.5946, MCE: 0.5500, HV: 0.3926
#   - Trade-off: -1.0% QDS, +18.8% MCE, +7.7% HV vs medium_veryhigh

# ============================================================================
# CHANGELOG
# ============================================================================
# 2025-12-12: CORRECTED based on average-based factorial selection
#   - Changed from small_tb to medium_veryhigh_tb (rank #1 by avg QDS)
#   - Changed num_layers: 2 → 3 (medium capacity)
#   - Added temperature: 5.0 (very high - critical for exploration!)
#   - Updated condition name: small_tb → medium_veryhigh_tb
#   - Updated expected QDS: 0.538 → 0.601 (+11.7% improvement)
#   - Updated expected MCE: 0.255 → 0.463 (+81.6% improvement)
#   - Updated expected HV: 0.779 → 0.364 (more stable, lower variance)
#   - Backup saved as: sequences_best_config_small_tb.yaml.backup
#
# 2025-12-11: Updated based on incomplete factorial analysis (INCORRECT)
#   - Selected small_tb which ranked only #8-10 across factorials
#   - This selection was based on cherry-picked seed or incomplete data
